name: Deploy Frontend (Pages) and Backend (Workers) via Wrangler CLI

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy to Cloudflare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    environment:
      name: production
      url: https://gracenook.thebiggydg2019.workers.dev/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack and prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.21.0 --activate
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_DEBUG: ${{ secrets.VITE_DEBUG }}
        run: pnpm build

      - name: Verify build output
        run: |
          echo "Build output contents:"
          ls -lah dist || true
          echo "---"
          head -n 20 dist/index.html || true

      - name: Install Wrangler (local)
        run: |
          corepack enable
          corepack prepare pnpm@10.21.0 --activate
          pnpm add -g wrangler@4 || pnpm add -D wrangler@4
          pnpm --silent exec wrangler --version

      - name: Wrangler auth debug
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Wrangler version and authentication info"
          pnpm --silent exec wrangler --version || true
          pnpm --silent exec wrangler whoami || true
          echo "Listing Pages projects (for the authenticated account)"
          pnpm --silent exec wrangler pages project list || true

      - name: Pre-deploy checks (secrets + pages project)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          # Fail early if essential secrets are missing
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "Required secret CLOUDFLARE_API_TOKEN is missing. Add it in repository Secrets."
            exit 1
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "Required secret CLOUDFLARE_ACCOUNT_ID is missing. Add it in repository Secrets."
            exit 1
          fi
          if [ -z "$VITE_API_URL" ]; then
            echo "Warning: VITE_API_URL is not set. Frontend may point to the wrong API."
          fi
          echo "Listing existing Pages projects for debugging"
          pnpm --silent exec wrangler pages project list || true

      - name: Deploy Frontend to Cloudflare Pages (CLI)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          echo "Deploying Pages project 'gracenook' from dist/"
          # Attempt deploy (pass --commit-dirty to silence uncommitted-changes warning)
          pnpm --silent exec wrangler pages deploy dist --project-name=gracenook --branch=main --commit-hash=${{ github.sha }} --commit-dirty=true || (
            echo "Pages deploy failed. Attempting to create Pages project 'gracenook' and re-deploy."
            pnpm --silent exec wrangler pages project create gracenook --production-branch=main || (
              echo "Could not create Pages project automatically. Please create the Pages project 'gracenook' in the Cloudflare dashboard and link the repository."
              exit 1
            )
            echo "Retrying pages deploy..."
            pnpm --silent exec wrangler pages deploy dist --project-name=gracenook --branch=main --commit-hash=${{ github.sha }} --commit-dirty=true
          )

      - name: Put Worker runtime secrets (JWT_SECRET)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          if [ -z "$JWT_SECRET" ]; then
            echo "JWT_SECRET not provided in repo secrets â€” skipping secret put"
            exit 0
          fi
          echo "Setting JWT_SECRET for Worker (production env)"
          echo "$JWT_SECRET" | pnpm --silent exec wrangler secret put JWT_SECRET --env production

      - name: Attempt Backend (Workers) Deploy (CLI)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Attempting to deploy Cloudflare Worker (if configured)..."
          # Deploy worker if wrangler.toml defines a worker or if src/index.* exists
          if [ -f wrangler.toml ] && grep -q "main\s*=\s*\"src/" wrangler.toml || [ -f src/index.js ] || [ -f src/index.ts ] || [ -f worker/index.js ] || [ -f worker/index.ts ]; then
            echo "Worker code detected - running wrangler deploy"
            pnpm --silent exec wrangler deploy --env production --account-id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }} || (echo "Worker deploy failed" && exit 1)
          else
            echo "No Worker entry point detected in repo; skipping worker deploy."
          fi

      - name: Success marker
        run: echo "Deploy workflow finished"
