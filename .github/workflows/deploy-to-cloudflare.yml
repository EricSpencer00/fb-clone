name: Deploy Frontend (Pages) and Backend (Workers) via Wrangler CLI

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy to Cloudflare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    environment:
      name: production
      url: https://gracenook.thebiggydg2019.workers.dev/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack and prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.21.0 --activate
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        env:
          VITE_DEBUG: ${{ secrets.VITE_DEBUG }}
        run: pnpm build

      - name: Verify build output
        run: |
          echo "Build output contents:"
          ls -lah dist || true
          echo "---"
          head -n 20 dist/index.html || true

      - name: Install Wrangler (local)
        run: |
          corepack enable
          corepack prepare pnpm@10.21.0 --activate
          pnpm add -g wrangler@4 || pnpm add -D wrangler@4
          pnpm --silent exec wrangler --version

      - name: Wrangler auth debug
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Wrangler version and authentication info"
          pnpm --silent exec wrangler --version || true
          pnpm --silent exec wrangler whoami || true
          echo "Listing Pages projects (for the authenticated account)"
          pnpm --silent exec wrangler pages project list || true

      - name: Pre-deploy checks (secrets + pages project)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          # Fail early if essential secrets are missing
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "Required secret CLOUDFLARE_API_TOKEN is missing. Add it in repository Secrets."
            exit 1
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "Required secret CLOUDFLARE_ACCOUNT_ID is missing. Add it in repository Secrets."
            exit 1
          fi
          if [ -z "$VITE_API_URL" ]; then
            echo "Warning: VITE_API_URL is not set. Frontend may point to the wrong API."
          fi
          echo "Listing existing Pages projects for debugging"
          pnpm --silent exec wrangler pages project list || true

      - name: Verify token account matches expected account id
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Verifying that the API token maps to the expected Cloudflare account id via API"
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN is empty"
            exit 1
          fi
          # Query Cloudflare API to list accounts accessible by the token
          accounts_json=$(curl -s -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" "https://api.cloudflare.com/client/v4/accounts")
          if [ -z "$accounts_json" ]; then
            echo "Empty response from Cloudflare accounts API"
            exit 1
          fi
          # Extract the first account id
          acct_id=$(echo "$accounts_json" | node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(0,'utf8')); if(j && j.result && j.result.length) console.log(j.result[0].id);") || true
          if [ -z "$acct_id" ]; then
            echo "Could not extract account id from Cloudflare API response. Response:"
            echo "$accounts_json"
            exit 1
          fi
          echo "Token account id: $acct_id"
          if [ "$acct_id" != "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "Mismatch: token belongs to $acct_id but expected $CLOUDFLARE_ACCOUNT_ID"
            echo "Ensure CLOUDFLARE_API_TOKEN is for the same account as CLOUDFLARE_ACCOUNT_ID and has Pages permissions."
            exit 1
          fi

      - name: Deploy Frontend to Cloudflare Pages (CLI)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          echo "Deploying Pages project 'fb-clone' from dist/"
          # Use --no-config to prevent Pages from reading wrangler.toml (which is for Workers)
          pnpm --silent exec wrangler pages deploy dist --project-name=fb-clone --branch=main --commit-hash=${{ github.sha }} --no-config || true

      - name: Put Worker runtime secrets (JWT_SECRET)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          if [ -z "$JWT_SECRET" ]; then
            echo "JWT_SECRET not provided in repo secrets â€” skipping secret put"
            exit 0
          fi
          echo "Setting JWT_SECRET for Worker (production env)"
          echo "$JWT_SECRET" | pnpm --silent exec wrangler secret put JWT_SECRET --env production --config wrangler.worker.toml

      - name: Attempt Backend (Workers) Deploy (CLI)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Attempting to deploy Cloudflare Worker..."
          # Deploy worker using wrangler.worker.toml config
          if [ -f wrangler.worker.toml ] && grep -q "main\s*=\s*\"src/worker.js" wrangler.worker.toml; then
            echo "Worker code detected - running wrangler deploy"
            pnpm --silent exec wrangler deploy --env production --config wrangler.worker.toml || (echo "Worker deploy failed" && exit 1)
          else
            echo "Worker configuration not found; skipping worker deploy."
          fi

      - name: Success marker
        run: echo "Deploy workflow finished"
